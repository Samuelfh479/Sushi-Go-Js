<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Comilona - Pa que vuelva y repita</title>
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFE66D;
            --dark-color: #292F36;
            --light-color: #F7FFF7;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .game-section {
            display: none;
            margin-top: 30px;
        }
        
        .setup-section {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        select, input, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #e05555;
        }
        
        .deck-option {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .deck-option:hover {
            background-color: #e0e0e0;
        }
        
        .deck-option.selected {
            background-color: var(--accent-color);
            border: 2px solid var(--primary-color);
        }
        
        .deck-info {
            margin-left: 15px;
        }
        
        .game-board {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .players-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        
        .player-area {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 250px;
        }
        
        .player-area.active {
            border: 3px solid var(--primary-color);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .player-points {
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .hand-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .card {
            width: 80px;
            height: 120px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            padding: 5px;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card.selected {
            transform: translateY(-10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--accent-color);
        }
        
        .played-cards {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
        }
        
        .played-cards-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .played-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .played-card {
            width: 60px;
            height: 90px;
            background-color: #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            padding: 3px;
            box-sizing: border-box;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .round-info {
            text-align: center;
            font-size: 1.2rem;
            margin: 20px 0;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .close-modal {
            background-color: var(--dark-color);
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .players-container {
                flex-direction: column;
            }
            
            .player-area {
                min-width: 100%;
            }
            
            .card {
                width: 60px;
                height: 90px;
                font-size: 0.7rem;
            }
        }
        .card-detail-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .card-detail-item h3 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .card-detail-item p {
            margin-bottom: 5px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1> CO La Comilona CO </h1>
            <p>Pa que coma y repita</p>
        </div>
    </header>
    
    <div class="container">
        <section id="setup-section" class="setup-section">
            <h2>Configuración del Juego</h2>
            
            <div class="form-group">
                <label for="player-count">Número de Jugadores (2-5):</label>
                <input type="number" id="player-count" min="2" max="5" value="2">
            </div>
            
            <div class="form-group">
                <label for="round-count">Número de Rondas (1-5):</label>
                <input type="number" id="round-count" min="1" max="5" value="1">
            </div>
            
            <h3>Selecciona un Mazo:</h3>
            <div id="deck-options">
                <div class="deck-option" data-deck="Clásico">
                    <div class="deck-info">
                        <h4>Clásico</h4>
                        <p>120 cartas - Incluye chicharron, picada, empanadas y más</p>
                    </div>
                </div>
                
                <div class="deck-option" data-deck="Con Esta No Engordo">
                    <div class="deck-info">
                        <h4>Con Esta No Engordo</h4>
                        <p>120 cartas - Incluye yuca, arroz guerrillero y ensalada de fruta</p>
                    </div>
                </div>
                
                <div class="deck-option" data-deck="El Ejecutivo">
                    <div class="deck-info">
                        <h4>El Ejecutivo</h4>
                        <p>120 cartas - Incluye consome, arroz guerrillero y ensalada de fruta</p>
                    </div>
                </div>
            </div>
            
            <button id="start-game">Comenzar Juego</button>
        </section>
        
        <section id="game-section" class="game-section">
            <div class="round-info" id="round-info">Ronda 1 de 3</div>
            
            <div class="game-board">
                <div class="players-container" id="players-container">
                    </div>
                
                <div class="game-controls">
                    <button id="end-round">Terminar Ronda</button>
                    <button id="show-scores">Ver Puntuaciones</button>
                    <button id="end-game">Terminar Juego</button>
                    <button id="show-card-details">Ver Cartas</button>
                </div>
            </div>
        </section>
    </div>
    <div id="card-details-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Detalles de las Cartas</h2>
            <div id="card-details-content">
                </div>
            <button class="close-modal">Cerrar</button>
        </div>
    </div>
    
    <div id="scores-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Puntuaciones</h2>
            <div id="scores-content">
                </div>
            <button class="close-modal">Cerrar</button>
        </div>
    </div>
    
    <div id="endgame-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Resultados Finales</h2>
            <div id="endgame-content">
                </div>
            <button class="close-modal">Cerrar</button>
            <button id="new-game">Nuevo Juego</button>
        </div>
    </div>
    
    <script>
        // Datos del juego
        const MAZOS = {
            "Clásico": [
                "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron",
                "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada",
                "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas",
                "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense",
                "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena",
                "arepa", "arepa", "arepa", "arepa", "arepa",
                "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)",
                "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)",
                "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)",
                "natilla", "natilla", "natilla", "natilla", "natilla", "natilla", "natilla", "natilla", "natilla", "natilla",
                "mantequilla", "mantequilla", "mantequilla", "mantequilla", "mantequilla", "mantequilla",
                "tenedor", "tenedor", "tenedor", "tenedor"
            ],
            "Con Esta No Engordo": [
                "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron",
                "yuca", "yuca", "yuca", "yuca", "yuca", "yuca", "yuca", "yuca", "yuca", "yuca","yuca", "yuca", "yuca", "yuca", "yuca",
                "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas", "empanadas",
                "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense",
                "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena",
                "arepa", "arepa", "arepa", "arepa", "arepa",
                "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)",
                "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)",
                "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)",
                "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta",
                "mantequilla", "mantequilla", "mantequilla", "mantequilla", "mantequilla", "mantequilla",
                "tenedor", "tenedor", "tenedor", "tenedor",
            ],
            "El Ejecutivo": [
                "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron", "chicharron",
                "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada", "picada",
                "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome", "consome",
                "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense", "arepa boyacense",
                "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena", "arepa rellena",
                "arepa", "arepa", "arepa", "arepa", "arepa",
                "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)", "arroz guerrillero(1)",
                "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)", "arroz guerrillero(2)",
                "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)", "arroz guerrillero(3)",
                "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta",
                "mantequilla", "mantequilla", "mantequilla", "mantequilla", "mantequilla", "mantequilla",
                "ensalada de fruta", "ensalada de fruta", "ensalada de fruta", "ensalada de fruta",
            ]
        };

        // Variables del juego
        let gameState = {
            players: [],
            currentRound: 1,
            totalRounds: 1,
            currentPlayer: 0,
            selectedDeck: "",
            cardsPerPlayer: 0,
            gamePhase: "setup" // setup, playing, roundEnd, gameEnd
        };

        // Elementos del DOM
        const setupSection = document.getElementById('setup-section');
        const gameSection = document.getElementById('game-section');
        const playersContainer = document.getElementById('players-container');
        const roundInfo = document.getElementById('round-info');
        const deckOptions = document.querySelectorAll('.deck-option');
        const startGameBtn = document.getElementById('start-game');
        const endRoundBtn = document.getElementById('end-round');
        const showScoresBtn = document.getElementById('show-scores');
        const endGameBtn = document.getElementById('end-game');
        const scoresModal = document.getElementById('scores-modal');
        const scoresContent = document.getElementById('scores-content');
        const endgameModal = document.getElementById('endgame-modal');
        const endgameContent = document.getElementById('endgame-content');
        const newGameBtn = document.getElementById('new-game');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const showCardDetailsBtn = document.getElementById('show-card-details');
        const cardDetailsModal = document.getElementById('card-details-modal');
        const cardDetailsContent = document.getElementById('card-details-content');


        // Event Listeners
        startGameBtn.addEventListener('click', startGame);
        endRoundBtn.addEventListener('click', endRound);
        showScoresBtn.addEventListener('click', showScores);
        endGameBtn.addEventListener('click', endGame);
        newGameBtn.addEventListener('click', resetGame);
        showCardDetailsBtn.addEventListener('click', showCardDetails);
        
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                scoresModal.style.display = 'none';
                cardDetailsModal.style.display = 'none';
                endgameModal.style.display = 'none';
            });
        });

        deckOptions.forEach(option => {
            option.addEventListener('click', () => {
                deckOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                gameState.selectedDeck = option.dataset.deck;
            });
        });

        // Funciones del juego
        function startGame() {
            const playerCount = parseInt(document.getElementById('player-count').value);
            const roundCount = parseInt(document.getElementById('round-count').value);
            
            if (playerCount < 2 || playerCount > 5) {
                alert("Número de jugadores inválido. Debe ser entre 2 y 5.");
                return;
            }
            
            if (roundCount < 1 || roundCount > 5) {
                alert("Número de rondas inválido. Debe ser entre 1 y 5.");
                return;
            }
            
            if (!gameState.selectedDeck) {
                alert("Por favor selecciona un mazo para jugar.");
                return;
            }
            
            // Configurar el juego
            gameState.players = Array(playerCount).fill().map(() => ({
                mano: [],
                cartasJugadas: [],
                puntos: 0,
                natillas: 0,
                ensalada_fruta: 0
            }));
            
            gameState.totalRounds = roundCount;
            gameState.currentRound = 1;
            gameState.currentPlayer = 0;
            
            // Determinar cartas por jugador según número de jugadores
            switch (playerCount) {
                case 2: gameState.cardsPerPlayer = 10; break;
                case 3: gameState.cardsPerPlayer = 9; break;
                case 4: gameState.cardsPerPlayer = 8; break;
                case 5: gameState.cardsPerPlayer = 7; break;
            }
            
            // Cambiar a la vista del juego
            setupSection.style.display = 'none';
            gameSection.style.display = 'block';
            gameState.gamePhase = "playing";
            
            // Iniciar la primera ronda
            startRound();
        }
        //Info de todas las cartas
        const CARD_DESCRIPTIONS = {
            "chicharron": {
                description: "Sumas puntos por cada par de chicharrones. Cuantos más pares, más puntos.",
                points: "5 puntos por cada 2 chicharrones."
                // image: "images/chicharron.png"
            },
            "picada": {
                description: "Obtienes puntos por cada tres picadas. Un plato abundante para grandes puntuaciones.",
                points: "10 puntos por cada 3 picadas."
                // image: "images/picada.png"
            },
            "empanadas": {
                description: "Las empanadas son deliciosas y te dan puntos según la cantidad que tengas. ¡Más es mejor!",
                points: "1: 1 punto, 2: 3 puntos, 3: 6 puntos, 4: 10 puntos, 5+: 15 puntos."
                // image: "images/empanadas.png"
            },
            "arepa boyacense": {
                description: "Una arepa tradicional que suma puntos individuales.",
                points: "2 puntos por cada una."
                // image: "images/arepa_boyacense.png"
            },
            "arepa rellena": {
                description: "La arepa rellena es más sustanciosa y te da más puntos.",
                points: "3 puntos por cada una."
                // image: "images/arepa_rellena.png"
            },
            "arepa": {
                description: "Una arepa básica que aporta puntos mínimos.",
                points: "1 punto por cada una."
                // image: "images/arepa.png"
            },
            "arroz guerrillero(1)": {
                description: "Parte de la serie Arroz Guerrillero. Contribuye a la suma total para el bono de mayoría.",
                points: "+1 al conteo de Arroz Guerrillero."
                // image: "images/arroz_guerrillero1.png"
            },
            "arroz guerrillero(2)": {
                description: "Parte de la serie Arroz Guerrillero. Contribuye significativamente al bono de mayoría.",
                points: "+2 al conteo de Arroz Guerrillero."
                // image: "images/arroz_guerrillero2.png"
            },
            "arroz guerrillero(3)": {
                description: "La carta de Arroz Guerrillero de mayor valor. Es clave para obtener la mayoría.",
                points: "+3 al conteo de Arroz Guerrillero."
                // image: "images/arroz_guerrillero3.png"
            },
            "natilla": {
                description: "Las natillas dan puntos al final del juego al jugador con más natillas y penalizan al que tiene menos.",
                points: "El que tiene más natillas al final, gana 6 puntos. El que tiene menos, pierde 6 puntos."
                // image: "images/natilla.png"
            },
            "mantequilla": {
                description: "Si juegas 'mantequilla' y la *siguiente* carta que juegas en la misma ronda es una arepa (arepa, arepa boyacense o arepa rellena), esa arepa vale el triple de sus puntos base.",
                points: "0 puntos. Triplica los puntos de la siguiente arepa jugada por el mismo jugador en la misma ronda."
                // image: "images/mantequilla.png"
            },
            "tenedor": {
                description: "Los tenedores son cartas que no tienen un efecto directo en la puntuación, pero pueden ser útiles para robar o intercambiar (si esa regla existiera).",
                points: "0 puntos. (Adjust as per actual game rules)"
                // image: "images/tenedor.png"
            },
            "yuca": {
                description: "La yuca otorga puntos si tienes una o dos. Más de dos no suman.",
                points: "1 yuca: 1 punto. 2 yucas: 6 puntos."
                // image: "images/yuca.png"
            },
           
            "ensalada de fruta": {
                description: "Las ensaladas de fruta dan puntos al final del juego al tener sets de 4.",
                points: "12 puntos por cada 4 ensaladas de fruta."
                // image: "images/ensalada_de_fruta.png"
            },
            "consome": {
                description: "Si eres el único jugador en tener 'consome', obtienes puntos. Si varios tienen 'consome', se anula.",
                points: "3 puntos si eres el único con 'consome'."
                // image: "images/consome.png"
            }
        };
        function showCardDetails() {
            cardDetailsContent.innerHTML = ''; // Clear previous content

            // Get all unique card names from all decks
            const allCardNames = new Set();
            for (const deckName in MAZOS) {
                MAZOS[deckName].forEach(card => allCardNames.add(card));
            }

            // Sort card names for consistent display
            const sortedCardNames = Array.from(allCardNames).sort();

            sortedCardNames.forEach(cardName => {
                const cardInfo = CARD_DESCRIPTIONS[cardName] || { description: "Descripción no disponible.", points: "Puntos no especificados.", image: "" };
                
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-detail-item'; // Add a class for styling
                cardDiv.innerHTML = `
                    <h3>${cardName.replace(/\(\d\)/g, '')}</h3> ${cardInfo.image ? `<img src="${cardInfo.image}" alt="${cardName}" style="width: 80px; height: 120px; margin-bottom: 10px;">` : ''}
                    <p><strong>Función:</strong> ${cardInfo.description}</p>
                    <p><strong>Puntuación:</strong> ${cardInfo.points}</p>
                    <hr>
                `;
                cardDetailsContent.appendChild(cardDiv);
            });

            cardDetailsModal.style.display = 'flex';
        }
        

        function startRound() {
            // Barajar el mazo
            const mazo = [...MAZOS[gameState.selectedDeck]];
            shuffleArray(mazo);
            
            // Repartir cartas a los jugadores
            for (let i = 0; i < gameState.players.length; i++) {
                gameState.players[i].mano = [];
                gameState.players[i].cartasJugadas = [];
                // Reset points for the new round's calculation (cumulative)
                gameState.players[i].puntos = 0; 
                
                for (let j = 0; j < gameState.cardsPerPlayer; j++) {
                    const cardIndex = i * gameState.cardsPerPlayer + j;
                    if (cardIndex < mazo.length) {
                        gameState.players[i].mano.push(mazo[cardIndex]);
                    }
                }
            }
            
            // Actualizar la interfaz
            updateGameUI();
            roundInfo.textContent = `Ronda ${gameState.currentRound} de ${gameState.totalRounds}`;
        }

        function updateGameUI() {
            playersContainer.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerArea = document.createElement('div');
                playerArea.className = `player-area ${index === gameState.currentPlayer ? 'active' : ''}`;
                
                playerArea.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">Jugador ${index + 1}</div>
                        <div class="player-points">${player.puntos} pts</div>
                    </div>
                    <div class="hand-container" id="hand-${index}"></div>
                    <div class="played-cards">
                        <div class="played-cards-title">Cartas Jugadas:</div>
                        <div class="played-cards-container" id="played-${index}"></div>
                    </div>
                `;
                
                playersContainer.appendChild(playerArea);
                
                // Añadir cartas a la mano
                const handContainer = document.getElementById(`hand-${index}`);
                player.mano.forEach((card, cardIndex) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.textContent = card;
                    cardElement.dataset.cardIndex = cardIndex;
                    
                    if (index === gameState.currentPlayer) {
                        cardElement.addEventListener('click', () => selectCard(index, cardIndex));
                    }
                    
                    handContainer.appendChild(cardElement);
                });
                
                // Añadir cartas jugadas
                const playedContainer = document.getElementById(`played-${index}`);
                player.cartasJugadas.forEach(card => {
                    const playedCard = document.createElement('div');
                    playedCard.className = 'played-card';
                    playedCard.textContent = card;
                    playedContainer.appendChild(playedCard);
                });
            });
        }

        function selectCard(playerIndex, cardIndex) {
            if (playerIndex !== gameState.currentPlayer) return; // Only active player can select
            
            const selectedCard = gameState.players[playerIndex].mano[cardIndex];
            
            if (selectedCard === "consome") {
                if (alguienJugoConsome(playerIndex)) {
                    alert("⚠️ ¡Otro jugador ya jugó consome! Esta carta será descartada.");
                }
            }
            
            // Move the card from hand to played cards
            const [playedCard] = gameState.players[playerIndex].mano.splice(cardIndex, 1);
            gameState.players[playerIndex].cartasJugadas.push(playedCard);
            
            // Check if all players have played a card for the current "trick" (turn within the round)
            const allPlayedTheirTurn = gameState.players.every(p => p.cartasJugadas.length === gameState.players[0].cartasJugadas.length);
            // This condition ensures everyone has played an equal number of cards in the current trick

            // If it's the end of a "trick" (everyone played one card in this turn of the round)
            if (allPlayedTheirTurn) {
                // Only rotate hands if there are still cards left to play in the hand for the current round
                // and it's not the very last card of the entire round for ALL players.
                if (gameState.players[0].mano.length > 0) { // Check if players still have cards in hand
                    const currentHands = gameState.players.map(player => [...player.mano]); // Create copies of current hands
                    const numPlayers = gameState.players.length;

                    for (let i = 0; i < numPlayers; i++) {
                        // The hand of player 'i' receives the hand of player 'i-1' (circularly)
                        gameState.players[i].mano = currentHands[(i + numPlayers - 1) % numPlayers];
                    }
                }
                
                // If all cards for the current round have been played by everyone
                if (gameState.players.every(p => p.cartasJugadas.length === gameState.cardsPerPlayer)) {
                    endRound();
                    return;
                }
            }
            
            // Move to the next player's turn
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            updateGameUI();
        }


        function endRound() {
            // Calcular puntuaciones de la ronda
            calculateScores();
            
            // Pasar a la siguiente ronda o terminar el juego
            if (gameState.currentRound < gameState.totalRounds) {
                gameState.currentRound++;
                gameState.currentPlayer = 0;
                startRound();
            } else {
                calculateFinalScores();
                endGame();
            }
        }

        function calculateScores() {
            // Arrays para contar arroz guerrillero
            const arrozGuerrilleros = Array(gameState.players.length).fill(0);
            
            // Clear current points for recalculation based on all played cards
            gameState.players.forEach(player => {
                player.puntos = 0; 
                player.natillas = 0; // Reset for recalculation of end-game effects
                player.ensalada_fruta = 0; // Reset for recalculation of end-game effects
            });

            // Primera pasada: contar cartas especiales y puntos básicos
            gameState.players.forEach((player, j) => {
                const contador = {};
                let mantequillaEffectActive = false; // Flag to track if mantequilla was just played

                // Iterate through cards played in sequence for mantequilla effect
                player.cartasJugadas.forEach(carta => {
                    contador[carta] = (contador[carta] || 0) + 1; // Count all cards normally

                    // Check for mantequilla effect
                    if (carta === "mantequilla") {
                        mantequillaEffectActive = true;
                    } else if (mantequillaEffectActive && 
                               (carta === "arepa" || carta === "arepa boyacense" || carta === "arepa rellena")) {
                        let baseArepaPoints = 0;
                        if (carta === "arepa") baseArepaPoints = 1;
                        else if (carta === "arepa boyacense") baseArepaPoints = 2;
                        else if (carta === "arepa rellena") baseArepaPoints = 3;
                        
                        // Add 2x base points to make it 3x total, as base points will be added later
                        player.puntos += baseArepaPoints * 2; 
                        mantequillaEffectActive = false; // Reset flag after applying bonus
                    } else {
                        mantequillaEffectActive = false; // Reset if the next card is not an affected arepa
                    }

                    // Count natillas and ensaladas for final scoring
                    if (carta === "natilla") player.natillas++;
                    if (carta === "ensalada de fruta") player.ensalada_fruta++;
                });
                
                // Calculate basic points (this now includes original arepa points)
                player.puntos += Math.floor((contador["chicharron"] || 0) / 2) * 5;
                player.puntos += Math.floor((contador["picada"] || 0) / 3) * 10;
                player.puntos += puntosEmpanadas(contador["empanadas"] || 0);
                player.puntos += puntosYuca(contador["yuca"] || 0);
                player.puntos += (contador["arepa boyacense"] || 0) * 2; // Original points
                player.puntos += (contador["arepa rellena"] || 0) * 3;   // Original points
                player.puntos += (contador["arepa"] || 0);             // Original points
                
                // Puntos por consome (si nadie más la jugó)
                // This logic needs to iterate over all played cards to check if ANY consome exists for other players
                const hasConsome = (contador["consome"] || 0) > 0;
                const otherPlayersPlayedConsome = gameState.players.some((otherPlayer, otherIndex) => 
                    otherIndex !== j && otherPlayer.cartasJugadas.includes("consome")
                );

                if (hasConsome && !otherPlayersPlayedConsome) {
                    player.puntos += 3;
                }
                
                // Contar arroces (now only arroz guerrillero)
                arrozGuerrilleros[j] = contarArrozGuerrillero(player.cartasJugadas);
            });
            
            // Calcular puntos por arroz guerrillero (applies to both decks now)
            const maxArrozGuerrillero = Math.max(...arrozGuerrilleros);
            if (maxArrozGuerrillero > 0) {
                // Find the second highest, filtering out values equal to the max
                const uniqueArrozGuerrilleros = [...new Set(arrozGuerrilleros)].sort((a,b) => b-a);
                const segundoArrozGuerrillero = uniqueArrozGuerrilleros.length > 1 ? uniqueArrozGuerrilleros[1] : -1; // -1 if no second highest
                
                gameState.players.forEach((player, j) => {
                    if (arrozGuerrilleros[j] === maxArrozGuerrillero) {
                        player.puntos += 6; // Highest adds 6
                    } else if (arrozGuerrilleros[j] === segundoArrozGuerrillero && segundoArrozGuerrillero > 0) {
                        player.puntos += 3; // Second highest adds 3
                    }
                });
            }
            
            
            // Mostrar puntuación parcial (this will now show the cumulative score)
            showScores();
        }

        function calculateFinalScores() {
            // Recalculate all scores one last time to ensure all bonuses are applied based on final counts
            // This is needed because `calculateScores` is called at the end of each round, but `natillas`
            // and `ensalada_fruta` points are applied here.
            // By calling calculateScores() here, we ensure final accumulation and then apply final bonuses.
            calculateScores(); // Re-calculate to ensure all previous round totals are correct

            const natillas = gameState.players.map(p => p.natillas);
            const maxNatilla = Math.max(...natillas);
            // Consider edge case where all players have 0 natillas, or all players have the same (max) natilla count
            const minNatilla = Math.min(...natillas); // No filter for > 0, as 0 is a valid min

            // Identify players with max/min natillas, considering ties
            const playersWithMaxNatilla = gameState.players.filter(p => p.natillas === maxNatilla && maxNatilla > 0);
            // For min natillas, we need to ensure they are not also tied for max (unless everyone has the same)
            const playersWithMinNatilla = gameState.players.filter(p => p.natillas === minNatilla);


            // Apply points for natillas
            // If there's a unique max natilla player, they get bonus. If tied, all tied get bonus.
            if (playersWithMaxNatilla.length > 0) {
                playersWithMaxNatilla.forEach(player => {
                    // Only add if they are not also a min (unless everyone is tied for max/min)
                    const isAlsoMin = playersWithMinNatilla.includes(player);
                    if (!isAlsoMin || (playersWithMaxNatilla.length === gameState.players.length)) {
                         player.puntos += 6;
                    }
                });
            }

            // Apply penalty for min natillas
            // If there's a unique min natilla player, they get penalty. If tied, all tied get penalty.
            if (playersWithMinNatilla.length > 0) {
                playersWithMinNatilla.forEach(player => {
                     // Only penalize if they are not also a max (unless everyone is tied for max/min)
                    const isAlsoMax = playersWithMaxNatilla.includes(player);
                    if (!isAlsoMax || (playersWithMinNatilla.length === gameState.players.length)) {
                        player.puntos -= 6;
                    }
                });
            }

            // Puntos por ensalada de fruta (12 puntos por cada 4 cartas)
            gameState.players.forEach(player => {
                player.puntos += Math.floor(player.ensalada_fruta / 4) * 12;
            });
        }

        // Funciones auxiliares para el cálculo de puntos
        function puntosEmpanadas(cantidad) {
            if (cantidad === 1) return 1;
            if (cantidad === 2) return 3;
            if (cantidad === 3) return 6;
            if (cantidad === 4) return 10;
            if (cantidad >= 5) return 15;
            return 0;
        }

        function puntosYuca(cantidad) {
            if (cantidad === 1) return 1;
            if (cantidad === 2) return 6;
            return 0;
        }

        function contarArrozGuerrillero(cartas) {
            return cartas.reduce((total, carta) => {
                if (carta === "arroz guerrillero(1)") return total + 1;
                if (carta === "arroz guerrillero(2)") return total + 2;
                if (carta === "arroz guerrillero(3)") return total + 3;
                return total;
            }, 0);
        }


        function alguienJugoConsome(jugadorActual) {
            // Check if any OTHER player has played 'consome' among all their played cards.
            return gameState.players.some((player, index) =>
                index !== jugadorActual &&
                player.cartasJugadas.includes("consome")
            );
        }
        // The obtenerTipoMasRepetido function has been removed.

        function showScores() {
            scoresContent.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerScore = document.createElement('div');
                playerScore.innerHTML = `
                    <h3>Jugador ${index + 1}</h3>
                    <p>Puntos: ${player.puntos}</p>
                    <p>Natillas: ${player.natillas}</p>
                    <p>Ensaladas de fruta: ${player.ensalada_fruta}</p>
                    <hr>
                `;
                scoresContent.appendChild(playerScore);
            });
            
            scoresModal.style.display = 'flex';
        }

        function endGame() {
            // Mostrar resultados finales
            endgameContent.innerHTML = '<h3>Resultados Finales</h3>';
            
            // Ordenar jugadores por puntuación
            const sortedPlayers = [...gameState.players].map((p, i) => ({...p, index: i}))
                .sort((a, b) => b.puntos - a.puntos);
            
            sortedPlayers.forEach((player, position) => {
                const playerResult = document.createElement('div');
                playerResult.innerHTML = `
                    <p><strong>${position + 1}º - Jugador ${player.index + 1}</strong></p>
                    <p>Puntos totales: ${player.puntos}</p>
                    <p>Natillas: ${player.natillas}</p>
                    <p>Ensaladas de fruta: ${player.ensalada_fruta}</p>
                    <hr>
                `;
                endgameContent.appendChild(playerResult);
            });
            
            endgameModal.style.display = 'flex';
            gameState.gamePhase = "gameEnd";
        }

        function resetGame() {
            // Volver a la configuración inicial
            gameState = {
                players: [],
                currentRound: 1,
                totalRounds: 1,
                currentPlayer: 0,
                selectedDeck: "",
                cardsPerPlayer: 0,
                gamePhase: "setup"
            };
            
            endgameModal.style.display = 'none';
            gameSection.style.display = 'none';
            setupSection.style.display = 'block';
            
            // Restablecer selección de mazo
            deckOptions.forEach(opt => opt.classList.remove('selected'));
            document.getElementById('player-count').value = 2;
            document.getElementById('round-count').value = 1;
        }

        // Función auxiliar para barajar array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
